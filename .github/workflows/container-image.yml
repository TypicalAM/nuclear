name: Build image
run-name: Build image

on: 
  workflow_dispatch:
  push:
    branches:
      - 'main'
    paths-ignore:
      - '**/*.md'
      - '*.md'
  schedule:
    - cron: '30 13 * * FRI'    # Triggers Fri at 13:30

env:
  IMAGE_REGISTRY: docker.piaseczny.dev
  IMAGE_NAME: machine/nuclear

jobs:
  io-image:
    runs-on: ubuntu-24.04
    steps:
    - name: Maximize build space
      uses: ublue-os/remove-unwanted-software@v8

    - name: Mount BTRFS for podman storage
      id: container-storage-action
      uses: ublue-os/container-storage-action@911baca08baf30c8654933e9e9723cb399892140
      continue-on-error: true
      with:
        target-dir: /var/lib/containers
        mount-opts: compress-force=zstd:2

    - name: Checkout
      uses: actions/checkout@v6

    - name: Podman login
      env:
        REGISTRY_USERNAME: ${{ secrets.REGISTRY_USER }}
        REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASS }}
      run: |
        echo "$REGISTRY_PASSWORD" | podman login docker.piaseczny.dev \
          --username "$REGISTRY_USERNAME" \
          --password-stdin

    - name: Build base image
      run: podman build -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest --target base .

    - name: Run Rechunker for base
      id: rechunk-base
      uses: ublue-os/legacy-rechunk@v1.0.0
      with:
        rechunk: 'ghcr.io/ublue-os/legacy-rechunk:v1.0.0-x86_64'
        ref: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        prev-ref: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        skip_compression: true

    - name: Load rechunked base image
      run: |
        IMAGE=$(podman pull ${{ steps.rechunk-base.outputs.ref }})
        sudo rm -rf ${{ steps.rechunk-base.outputs.output }}
        podman tag $IMAGE ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Build NVIDIA image
      run: podman build -t ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia --target nvidia .

    - name: Run Rechunker for nvidia
      id: rechunk-nvidia
      uses: ublue-os/legacy-rechunk@v1.0.0
      with:
        rechunk: 'ghcr.io/ublue-os/legacy-rechunk:v1.0.0-x86_64'
        ref: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia"
        prev-ref: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia"
        skip_compression: true

    - name: Load rechunked nvidia image
      run: |
        IMAGE=$(podman pull ${{ steps.rechunk-nvidia.outputs.ref }})
        sudo rm -rf ${{ steps.rechunk-nvidia.outputs.output }}
        podman tag $IMAGE ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia

    - name: Push base image
      run: podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Push NVIDIA image
      run: podman push ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:nvidia
